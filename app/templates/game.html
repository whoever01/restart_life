<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¨¡æ‹Ÿæ‰‹æœºç•Œé¢</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="phone">
    <div class="status-bar">
      <div class="status-item">
        <span id="current-age">æœªå‡ºç”Ÿ</span>
      </div>
      <div class="status-item">
        <span id="current-year">2025</span>
      </div>
    </div>
    <div class="content">
      <div class="tab-bar">
        <button class="tab-button active" data-tab="events" onclick="showTab('events')">äº‹ä»¶</button>
        <button class="tab-button" data-tab="social" onclick="showTab('social')">å¾®ä¿¡</button>
      </div>
      <div id="events-view" class="view" style="display: flex;">
        <div class="player-info">
          <div class="info-column">
            <div class="info-item">
              <span class="info-icon">ğŸ‘¤</span>
              <span id="player-name" class="info-value"></span>
            </div>
            <div class="info-item">
              <span class="info-icon">âš¤</span>
              <span id="player-gender" class="info-value"></span>
            </div>
          </div>
          <div class="info-column">
            <div class="info-item">
              <span class="info-icon">ğŸ§ </span>
              <div class="stat-info">
                <span class="stat-label">æ™ºåŠ›</span>
                <span id="intelligence" class="stat-value">0</span>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ’ª</span>
              <div class="stat-info">
                <span class="stat-label">ä½“è´¨</span>
                <span id="physical" class="stat-value">0</span>
              </div>
            </div>
          </div>
          <div class="info-column">
            <div class="info-item">
              <span class="info-icon">âœ¨</span>
              <div class="stat-info">
                <span class="stat-label">é¢œå€¼</span>
                <span id="appearance" class="stat-value">0</span>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">ğŸ’°</span>
              <div class="stat-info">
                <span class="stat-label">å®¶å¢ƒ</span>
                <span id="wealth" class="stat-value">0</span>
              </div>
            </div>
          </div>
        </div>
        
        <div id="event-list" class="scrollable">
        </div>
        
        <!-- æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡ -->
        <div class="scroll-track">
          <div class="scroll-thumb"></div>
        </div>
        
        <div class="buttons-container">
          <button id="next-year-button" onclick="nextYear()">å‡ºç”Ÿ</button>
        </div>
      </div>
      <div id="social-view" class="view" style="display: none;">
        <div class="chat-list">
          <!-- èŠå¤©åˆ—è¡¨å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      <!-- æ·»åŠ èŠå¤©çª—å£ -->
      <div id="chat-window" class="chat-window" style="display: none;">
        <div class="chat-header">
          <button onclick="closeChat()" class="back-button">è¿”å›</button>
          <span id="chat-contact-name"></span>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="chat-input-area">
          <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
          <button onclick="sendMessage()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
  <script>
  let gameData = null;  // å£°æ˜å…¨å±€å˜é‡
  
  // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å±æ€§æ•°æ®
  document.addEventListener('DOMContentLoaded', function() {
      gameData = JSON.parse(localStorage.getItem('gameData'));
      if (gameData) {
          // æ›´æ–°åŸºæœ¬ä¿¡æ¯
          document.getElementById('player-name').textContent = gameData.name;
          document.getElementById('player-gender').textContent = gameData.sex;
          
          // æ›´æ–°å±æ€§å€¼
          document.getElementById('intelligence').textContent = String(gameData.attributes.æ™ºåŠ› || 10);
          document.getElementById('physical').textContent = String(gameData.attributes.ä½“è´¨ || 10);
          document.getElementById('appearance').textContent = String(gameData.attributes.é¢œå€¼ || 10);
          document.getElementById('wealth').textContent = String(gameData.attributes.å®¶å¢ƒ || 10);
          
          // å¯ä»¥æ·»åŠ å…¶ä»–åˆå§‹åŒ–é€»è¾‘
          console.log('ç©å®¶åŸå¸‚:', gameData.city);
          console.log('ç©å®¶å¤©èµ‹:', gameData.talents);
          
          // åˆå§‹åŒ–çŠ¶æ€æ 
          document.getElementById('current-year').textContent = currentYear;
          document.getElementById('current-round').textContent = '1';
      }
  });

  // æ·»åŠ äº‹ä»¶æŠ˜å /å±•å¼€åŠŸèƒ½
  function toggleEventDetail(header) {
      const eventItem = header.parentElement;
      eventItem.classList.toggle('expanded');
  }

  // æ·»åŠ äº‹ä»¶çš„å‡½æ•°
  function addEvent(year, age, effect, detail) {
      const eventList = document.getElementById('event-list');
      const eventItem = document.createElement('div');
      eventItem.className = 'event-item expanded';  // æ·»åŠ  expanded ç±»ä½¿å…¶é»˜è®¤å±•å¼€
      
      eventItem.innerHTML = `
        <div class="event-header" onclick="toggleEventDetail(this)">
          <span class="event-year">${year}å¹´</span>
          <span class="event-age">${age}å²</span>
          ${effect ? `<span class="event-effect">${effect}</span>` : ''}
        </div>
        <div class="event-detail">
          ${detail}
        </div>
      `;
      
      eventList.appendChild(eventItem);
      
      // è‡ªåŠ¨æ»šåŠ¨åˆ°æ–°äº‹ä»¶
      eventItem.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }

  let currentYear = 2025;
  let currentAge = -1;  // -1 è¡¨ç¤ºæœªå‡ºç”Ÿ
  let isFirstClick = true;

  // å¤„ç†æ–°æ¶ˆæ¯
  function handleNewMessages(messages) {
    if (!messages || !messages.length) return;
    
    messages.forEach(message => {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°è§’è‰²
      if (message.fromCharacter) {
        // æ‰¾åˆ°æˆ–åˆ›å»ºè¿™ä¸ªè§’è‰²çš„èŠå¤©è®°å½•
        let contact = contacts.find(c => c.name === message.fromCharacter);
        if (!contact) {
          contact = {
            name: message.fromCharacter,
            messages: [],
            unread: 0
          };
          contacts.push(contact);
        }
        
        // æ·»åŠ æ¶ˆæ¯
        if (message.messageChain) {
          message.messageChain.forEach(msg => {
            contact.messages.push({
              text: msg.text,
              year: currentYear,
              from: 'other',
              effects: msg.effects,
              hasEffect: msg.hasEffect
            });
          });
          
          // æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°
          contact.unread += message.messageChain.length;
          
          // æ›´æ–°æœ€æ–°æ¶ˆæ¯é¢„è§ˆ
          const lastMessage = message.messageChain[message.messageChain.length - 1];
          contact.message = lastMessage.text;
          
          // å¦‚æœæœ‰å›å¤é€‰é¡¹ï¼Œä¿å­˜åˆ°æ¶ˆæ¯ä¸­
          if (message.responses) {
            contact.messages[contact.messages.length - 1].responses = message.responses;
          }
        }
        
        // å¤„ç†è§’è‰²æ•ˆæœ
        if (message.characterEffect) {
          contact.relationship = message.characterEffect.type;
        }
        
        // å¦‚æœå½“å‰æ­£åœ¨ä¸è¿™ä¸ªè”ç³»äººèŠå¤©ï¼Œç«‹å³æ›´æ–°èŠå¤©çª—å£
        const currentContactName = document.getElementById('chat-contact-name');
        if (currentContactName && currentContactName.textContent === contact.name) {
          showChatWindow(contact);
        }
      }
    });
    
    // åˆ·æ–°è”ç³»äººåˆ—è¡¨
    initChatList();
    
    // å¦‚æœå½“å‰åœ¨ç¤¾äº¤ç•Œé¢ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯æé†’
    const socialView = document.getElementById('social-view');
    if (socialView.style.display !== 'none') {
      socialView.classList.add('new-message');
      setTimeout(() => {
        socialView.classList.remove('new-message');
      }, 1000);
    }
  }

  function showChatWindow(contact) {
    const chatWindow = document.getElementById('chat-window');
    const chatContactName = document.getElementById('chat-contact-name');
    const chatMessages = document.getElementById('chat-messages');
    
    chatContactName.textContent = contact.name;
    chatMessages.innerHTML = '';
    
    // æŒ‰å¹´ä»½å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç»„å¹¶æ˜¾ç¤º
    const messagesByYear = {};
    contact.messages.forEach(msg => {
      const year = msg.year || currentYear;  // å¦‚æœæ²¡æœ‰å¹´ä»½ï¼Œä½¿ç”¨å½“å‰å¹´ä»½
      if (!messagesByYear[year]) {
        messagesByYear[year] = [];
      }
      messagesByYear[year].push(msg);
    });
    
    // æŒ‰å¹´ä»½æ˜¾ç¤ºæ¶ˆæ¯
    Object.keys(messagesByYear).sort().forEach(year => {
      // æ·»åŠ å¹´ä»½åˆ†éš”çº¿
      const yearDivider = document.createElement('div');
      yearDivider.className = 'year-divider';
      yearDivider.innerHTML = `
        <span class="year-text">${year}</span>
        <div class="divider-line"></div>
      `;
      chatMessages.appendChild(yearDivider);
      
      // æ˜¾ç¤ºè¯¥å¹´ä»½çš„æ¶ˆæ¯
      messagesByYear[year].forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.from === 'self' ? 'self' : 'other'}`;
        messageDiv.innerHTML = `
          <div class="message-content">
            <p>${msg.text}</p>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
      });
    });
    
    // æ¸…é™¤æœªè¯»æ¶ˆæ¯è®¡æ•°
    contact.unread = 0;
    
    // æ˜¾ç¤ºèŠå¤©çª—å£
    chatWindow.style.display = 'flex';
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function nextYear() {
    try {
      console.log('Current game data:', gameData);
      // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¸¸æˆç»“æŸæ¡ä»¶ï¼ˆä¾‹å¦‚80å²ï¼‰
      if (currentAge >= 80) {
        alert('ä½ å·²ç»åº¦è¿‡äº†ç²¾å½©çš„ä¸€ç”Ÿï¼æ¸¸æˆç»“æŸã€‚');
        document.getElementById('next-year-button').disabled = true;
        return;
      }

      const button = document.getElementById('next-year-button');
      button.disabled = true;
      
      // å¤„ç†ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼ˆå‡ºç”Ÿï¼‰
      if (isFirstClick) {
        currentAge = 0;
        document.getElementById('current-age').textContent = '0å²';
        button.textContent = 'ä¸‹ä¸€å¹´';
        isFirstClick = false;
      } else {
        currentAge++;
        currentYear++;
        document.getElementById('current-age').textContent = `${currentAge}å²`;
        document.getElementById('current-year').textContent = `${currentYear}å¹´`;
      }

      // å‡†å¤‡å‘é€ç»™åç«¯çš„æ•°æ®
      const context = {
        name: document.getElementById('player-name').textContent,
        sex: document.getElementById('player-gender').textContent,
        age: currentAge.toString(),
        appearance: String(parseInt(document.getElementById('appearance').textContent) || 10),
        intelligence: String(parseInt(document.getElementById('intelligence').textContent) || 10),
        physical: String(parseInt(document.getElementById('physical').textContent) || 10),
        wealth: String(parseInt(document.getElementById('wealth').textContent) || 10),
        city: (gameData && gameData.city) || 'åŒ—äº¬',
        character: gameData.character || '',
        characters: gameData.characters || '',
        events: gameData.events || '',
        messages: gameData.messages || '',
        talents: gameData.talents || []  // æ·»åŠ å¤©èµ‹åˆ—è¡¨
      };

      // å‘é€è¯·æ±‚è·å–äº‹ä»¶
      const response = await fetch('/generate_event', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ context: context })
      });

      if (!response.ok) {
        throw new Error('è·å–äº‹ä»¶å¤±è´¥');
      }

      const eventData = await response.json();
      if (!eventData || typeof eventData.content !== 'string') {
        throw new Error('äº‹ä»¶æ•°æ®æ ¼å¼é”™è¯¯');
      }

      // åˆ›å»ºæ–°çš„äº‹ä»¶å…ƒç´ 
      const eventItem = document.createElement('div');
      eventItem.className = 'event-item';
      
      // åº”ç”¨äº‹ä»¶æ•ˆæœ
      if (eventData.effects) {
        Object.entries(eventData.effects).forEach(([attr, value]) => {
          // è½¬æ¢å±æ€§åç§°
          const attrMap = {
            'intelligence': 'intelligence',
            'physical': 'physical',
            'appearance': 'appearance',
            'wealth': 'wealth'
          };
          const elementId = attrMap[attr.toLowerCase()];
          const element = document.getElementById(elementId);
          if (element) {
            const currentValue = parseInt(element.textContent) || 0;
            element.textContent = Math.max(0, Math.min(20, currentValue + value));
          }
        });
      }

      // æ›´æ–°äº‹ä»¶æ˜¾ç¤º
      eventItem.innerHTML = `
        <div class="event-header" onclick="toggleEventDetail(this)">
          <span class="event-year">${currentYear}å¹´</span>
          <span class="event-age">${currentAge}å²</span>
          ${eventData.effects ? `<span class="event-effect">${formatEffects(eventData.effects)}</span>` : ''}
        </div>
        <div class="event-detail">
          ${eventData.content}
        </div>
      `;

      // æ·»åŠ åˆ°äº‹ä»¶åˆ—è¡¨
      const eventList = document.getElementById('event-list');
      eventList.appendChild(eventItem);

      // å¤„ç†è§¦å‘å™¨ï¼ˆå¦‚å¾®ä¿¡æ¶ˆæ¯ç­‰ï¼‰
      if (eventData.triggers && eventData.triggers.messages) {
        handleNewMessages(eventData.triggers.messages);
      }

      // è‡ªåŠ¨æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„äº‹ä»¶
      setTimeout(() => {
        const eventList = document.getElementById('event-list');
        eventList.scrollTo({
          top: eventList.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);

      button.disabled = false;
    } catch (error) {
      console.error('ç”Ÿæˆäº‹ä»¶å¤±è´¥:', error);
      console.error('é”™è¯¯è¯¦æƒ…:', { gameData, currentAge, currentYear });
      alert('è·å–äº‹ä»¶å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      button.disabled = false;
    }
  }

  // æ ¼å¼åŒ–æ•ˆæœæ˜¾ç¤º
  function formatEffects(effects) {
    return Object.entries(effects)
      .map(([attr, value]) => {
        const attrNames = {
          'intelligence': 'æ™ºåŠ›',
          'physical': 'ä½“è´¨',
          'appearance': 'é¢œå€¼',
          'wealth': 'å®¶å¢ƒ'
        };
        const displayName = attrNames[attr.toLowerCase()] || attr;
        return `${displayName}${value > 0 ? '+' : ''}${value}`;
      })
      .join(' ');
  }

  // æ·»åŠ ä¸€äº› CSS æ ·å¼
  </script>

  <style>
  button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
  }

  button {
      transition: opacity 0.3s ease;
  }

  .loading {
      position: relative;
  }

  .loading:after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin: -8px 0 0 -8px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .player-info {
    display: grid;
    grid-template-columns: 0.8fr 1fr 1fr;
    gap: 10px;
    padding: 12px;
    background: rgba(7, 193, 96, 0.05);
    border-radius: 12px;
    margin-bottom: 10px;
    height: 80px;
  }

  .info-column {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 5px;
    position: relative;
  }

  .info-column:not(:last-child)::after {
    content: '';
    position: absolute;
    right: -5px;
    top: 10%;
    height: 80%;
    width: 1px;
    background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1), transparent);
  }

  .info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px;
  }

  .info-icon {
    font-size: 16px;
    opacity: 0.7;
    margin: 0;
  }

  .info-value {
    font-size: 16px;
    color: #2c3e50;
    font-weight: 500;
    max-width: 84px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .stat-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .stat-label {
    color: #666;
    margin: 0;
    font-size: 12px;
  }

  .stat-value {
    font-weight: bold;
    color: #2c3e50;
    margin: 0;
    font-size: 16px;
  }

  /* äº‹ä»¶åˆ—è¡¨æ ·å¼ */
  .event-item {
    background: #fff;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
  }

  .event-header {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    background: rgba(7, 193, 96, 0.05);
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .event-header:hover {
    background: rgba(7, 193, 96, 0.1);
  }

  .event-year {
    font-weight: 500;
    color: #2c3e50;
    margin-right: 12px;
    font-size: 17px;
  }

  .event-age {
    color: #666;
    margin-right: 12px;
    font-size: 17px;
  }

  .event-effect {
    color: #07c160;
    font-weight: 500;
    font-size: 17px;
    margin-left: auto;
  }

  .event-detail {
    padding: 16px 20px;
    color: #2c3e50;
    font-size: 16px;
    line-height: 1.5;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    display: none;
    background: #fafafa;
  }

  .event-item.expanded .event-detail {
    display: block;
  }

  .event-item.expanded .event-header {
    background: rgba(7, 193, 96, 0.1);
  }

  /* äº‹ä»¶åˆ—è¡¨å®¹å™¨æ ·å¼ */
  .scrollable {
    padding: 15px;
    flex: 1;
    overflow-y: auto;
  }

  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
  .scrollable::-webkit-scrollbar {
    width: 8px;
  }

  .scrollable::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.02);
    border-radius: 4px;
  }

  .scrollable::-webkit-scrollbar-thumb {
    background: rgba(7, 193, 96, 0.2);
    border-radius: 4px;
  }

  .scrollable::-webkit-scrollbar-thumb:hover {
    background: rgba(7, 193, 96, 0.3);
  }

  /* æ–°æ¶ˆæ¯æé†’åŠ¨ç”» */
  @keyframes newMessage {
    0% { background-color: rgba(7, 193, 96, 0.1); }
    50% { background-color: rgba(7, 193, 96, 0.2); }
    100% { background-color: rgba(7, 193, 96, 0.1); }
  }

  .new-message {
    animation: newMessage 1s ease;
  }
  </style>

  <script>
  function showTab(tabName) {
    // éšè—æ‰€æœ‰è§†å›¾
    document.querySelectorAll('.view').forEach(view => {
      view.style.display = 'none';
      view.style.visibility = 'hidden';  // æ·»åŠ å¯è§æ€§æ§åˆ¶
    });
    
    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.tab-button').forEach(button => {
      button.classList.remove('active');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾
    const selectedView = document.getElementById(tabName + '-view');
    selectedView.style.display = 'flex';
    selectedView.style.visibility = 'visible';  // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾
    
    // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  }
  </script>

  <script>
  function sendMessage() {
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    if (message) {
      const chatMessages = document.getElementById('chat-messages');
      const year = document.getElementById('current-year').textContent;
      
      // è·å–å½“å‰èŠå¤©çš„è”ç³»äººåç§°
      const contactName = document.getElementById('chat-contact-name').textContent;
      const currentContact = contacts.find(contact => contact.name === contactName);
      
      if (currentContact) {
        currentContact.messages.push({
          text: message,
          year: currentYear,
          from: 'self'
        });
        
        // åˆ›å»ºæ–°æ¶ˆæ¯å…ƒç´ 
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message self';
        messageDiv.innerHTML = `
          <div class="message-content">
            <p>${message}</p>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        chatInput.value = '';
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // è·å– AI å›å¤
        getAIResponse(currentContact, message).then(response => {
          if (response && response.messages && response.messages.length > 0) {
            handleNewMessages(response.messages);
          }
        });
      }
    }
  }

  // è·å– AI å›å¤
  async function getAIResponse(contact, message) {
    try {
      // è·å–å½“å‰æ¸¸æˆçŠ¶æ€
      const currentState = {
        name: document.getElementById('player-name').textContent,
        sex: document.getElementById('player-gender').textContent,
        age: currentAge.toString(),
        appearance: document.getElementById('appearance').textContent,
        intelligence: document.getElementById('intelligence').textContent,
        physical: document.getElementById('physical').textContent,
        wealth: document.getElementById('wealth').textContent,
        city: gameData.city,
        character: contact.name,
        characters: contact.name,
        events: gameData.events || [],
        messages: contact.messages.map(msg => {
          const sender = msg.from === 'self' ? gameData.name : contact.name;
          return `${currentAge}å² ${sender}: [${msg.text}]`;
        }).join('ï¼›')
      };
      
      const response = await fetch('/get_messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          context: currentState
        })
      });
      
      if (!response.ok) {
        throw new Error('è·å–æ¶ˆæ¯å¤±è´¥');
      }
      
      return await response.json();
    } catch (error) {
      console.error('è·å– AI å›å¤å¤±è´¥:', error);
      return null;
    }
  }
  </script>
</body>
</html>
